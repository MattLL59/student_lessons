<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone &amp; Structure Architect v55 (Total Control)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #37474f;
            --tone-col: #9c27b0;
            --struct-col: #2196f3;
            --lang-col: #4caf50;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }

        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0; margin-bottom: 20px;
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.4rem; display:flex; align-items:center; gap:10px; }
        
        .admin-btn { 
            font-size: 1.2rem; color: #555; background: #eee; border: none; 
            border-radius: 5px; padding: 8px 12px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { background: #ddd; }

        .container { 
            flex-grow: 1; max-width: 1100px; width: 100%; margin: 0 auto; 
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; 
        }

        .stage { display: none; animation: fadeIn 0.3s; }
        .stage.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .instruction { color: #78909c; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .dynamic-question { font-size: 1.4rem; color: var(--primary); font-weight: bold; margin-bottom: 20px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #ddd;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary); }
        .card-struct { border-left: 5px solid var(--struct-col) !important; background: #f4faff !important; text-align: left; align-items: flex-start !important; }
        .card-lang { border-left: 5px solid var(--lang-col) !important; }
        .card-tone { border-left: 5px solid var(--tone-col) !important; }

        .card strong { font-size: 1.1rem; display: block; margin-bottom: 5px; color: #333; }
        .card small { font-size: 0.85rem; color: #666; font-style: italic; }

        /* BUILDER PANEL */
        .builder-panel {
            background: white; border-radius: 10px; padding: 20px; border-top: 4px solid var(--primary);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        
        .controls { 
            display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; 
            padding-bottom: 15px; border-bottom: 1px dashed #eee;
        }
        
        .bank-group { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; }
        .bank-label { font-size: 0.7rem; color: #999; font-weight: bold; text-transform: uppercase; }
        
        select.bank-select { 
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; 
            background: #f9f9f9; font-weight: 500; cursor: pointer; min-width: 140px; max-width: 200px;
        }
        select.bank-select:hover { border-color: var(--primary); background: white; }

        .locked-slot {
            padding: 8px 12px; border: 1px dashed var(--primary); border-radius: 5px;
            background: #e0f2f1; color: var(--primary-dark); font-size: 0.85rem;
            font-weight: bold; display: flex; align-items: center; justify-content: center;
            min-width: 140px; text-align: center;
        }

        #sentence-stage { width: 98%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; font-size: 1.1rem; margin-bottom: 5px; }
        #structure-preview { font-size: 0.75rem; color: #888; text-align: left; margin-bottom: 15px; font-family: monospace; }
        
        #answer-area { width: 98%; height: 150px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Segoe UI'; font-size: 1rem; resize: vertical; display: none; }

        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: all 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-doc { background: #2b5797; }
        .btn-danger { background: #e74c3c; padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        .btn-add { background: #2ecc71; width: 100%; margin-top: 5px; }
        .btn-warning { background: #f39c12; color: white; }
        
        .btn-edit-analysis {
            background-color: #9c27b0;
            color: white;
            font-size: 0.9rem;
            padding: 6px 12px;
            border: 1px solid #7b1fa2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-edit-analysis:hover { background-color: #7b1fa2; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }

        .list-container { margin-bottom: 15px; }
        .list-item { display: flex; align-items: center; margin-bottom: 5px; }
        .list-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; }
        
        .analysis-details { margin-top: 10px; padding: 15px; border: 2px solid #9c27b0; border-radius: 5px; background: #fdfbff; display:none; }
        .lens-group { display: none; } 
        .lens-group.active { display: block; animation: fadeIn 0.3s; }
        .level-block { margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        
        #wizard-overlay { flex-direction:column; padding:20px; box-sizing:border-box; background: white; }
        
        #phrasing-overlay { z-index: 2000; background: rgba(0,0,0,0.8); }
        .phrase-option { 
            background: #f0f4c3; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            cursor: pointer; font-size: 1.1rem; border: 2px solid transparent; transition:0.2s; 
        }
        .phrase-option:hover { border-color: var(--primary); background: #fff; transform: scale(1.02); }

        #overlay-msg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); z-index: 3000; color: white; flex-direction: column; justify-content: center; align-items: center; }
        
        .hard-reset-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; }
        .filter-bar { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
        .filter-btn { padding: 5px 15px; border: 1px solid #ccc; background: white; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .toolbar-icon { font-size: 1.1rem; margin-right: 5px; cursor: pointer; }
        .ws-checkbox { transform: scale(1.3); margin-right: 5px; }
    </style>
</head>
<body data-new-gr-c-s-check-loaded="14.1268.0" data-gr-ext-installed="">

    <header>
        <h1><i class="fas fa-cubes"></i> Tone &amp; Structure v55</h1>
        <div>
            <button class="hard-reset-btn" onclick="hardReset()">‚ö†Ô∏è Factory Reset</button>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation</option>
                <option value="2">Level 2: Developing</option>
                <option value="3">Level 3: Secure</option>
            </select>
            <button class="admin-btn" onclick="requestAdminAccess()"><i class="fas fa-cog"></i> Settings</button>
        </div>
    </header>

    <div class="container">
        <div style="display:flex; justify-content:space-between; color:#607d8b; font-size:0.9rem;">
            <span><strong>Text:</strong> <span id="text-display">The Electric Telegraph</span></span>
            <span><strong>Q:</strong> <span id="q-display">How does the writer try to show the impact the electric telegraph could have on communication?</span></span>
        </div>

        <div id="stage-select" class="stage active">
            <div class="instruction">Step 1: Evidence</div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterGrid('all', this)">All</button>
                <button class="filter-btn" onclick="filterGrid('language', this)">Tone/Lang</button>
                <button class="filter-btn" onclick="filterGrid('structure', this)">Structure</button>
            </div>
            <div id="dynamic-question-display" class="dynamic-question">Select Evidence to Analyze</div>
            <div class="grid" id="grid-main"><div class="card card-lang"><strong>üî§ "The electric telegraph, a wondrous invention of our age"</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">What kind of tone does the author use with this quote?</small></div><div class="card card-lang"><strong>üî§ "marvel of instantaneous communication"</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">What is the essential meaning in the phrase</small></div><div class="card card-lang"><strong>üî§ "No longer confined"</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">What is implied by the phrase</small></div><div class="card card-lang"><strong>üî§ "slow and uncertain services of horse and ship"</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">Why does the author use</small></div><div class="card card-lang"><strong>üî§ "defying previous conceptions of time and space"</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">What does this quote mean?</small></div><div class="card card-struct"><strong>üèóÔ∏è Opening vs Ending</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">How does the the focus of the text change over the whole piece?</small></div><div class="card card-struct"><strong>üèóÔ∏è The Past vs Present Shift</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">How does the first paragraph reflect the whole article?</small></div></div>
        </div>

        <div id="stage-decoder" class="stage">
            <div class="instruction">Step 2: Translation Bridge</div>
            <div style="background:#e0f2f1; padding:20px; border-radius:8px; margin-bottom:20px; font-size:1.2rem;">
                "<span id="decoder-quote"></span>"
            </div>
            <div class="grid" id="grid-decoder"></div>
        </div>

        <div id="stage-lens" class="stage">
            <div class="instruction">Step 3: Select Lens</div>
            <div class="grid">
                <div class="card card-tone" onclick="loadAnalysis('tone')"><strong>üé≠ Tone</strong><small>Emotion</small></div>
                <div class="card card-struct" onclick="loadAnalysis('structure')"><strong>üèóÔ∏è Structure</strong><small>Order/Shift</small></div>
                <div class="card card-lang" onclick="loadAnalysis('language')"><strong>üìñ Language</strong><small>Devices</small></div>
            </div>
        </div>

        <div id="stage-analysis" class="stage">
            <div class="instruction" id="analysis-prompt">...</div>
            <div class="grid" id="grid-analysis"></div>
        </div>
    </div>

    <div class="builder-panel">
        <div class="instruction" style="text-align:center;">Answer Builder</div>
        <div class="controls" id="dynamic-builder-controls"><div class="bank-group"><span class="bank-label">1. Starter</span><select class="bank-select" id="sel-starter"><option value="">‚ûï Starter</option><option value="The writer implies">The writer implies</option><option value="The writer suggests">The writer suggests</option><option value="The writer presents">The writer presents</option><option value="The writer uses">The writer uses</option><option value="The writer includes">The writer includes</option></select></div><div class="bank-group"><span class="bank-label">2. Quote (From Card)</span><div class="locked-slot"><i class="fas fa-quote-right"></i>&nbsp;Quote</div></div><div class="bank-group"><span class="bank-label">4. Link</span><select class="bank-select" id="sel-link"><option value="">‚ûï Link</option><option value="This reinforces the idea that">This reinforces the idea that</option><option value="linking back to">linking back to</option><option value="creating a sense of">creating a sense of</option><option value="which leads us to believe">which leads us to believe</option><option value="this makes us aware of">this makes us aware of</option><option value=" the writer believes "> the writer believes </option><option value="the writer's conviction">the writer's conviction</option><option value="The author can see">The author can see</option><option value="which reminds us">which reminds us</option></select></div><div class="bank-group"><span class="bank-label">5. Point</span><select class="bank-select" id="sel-point"><option value="">‚ûï Point</option><option value="the telegraph will have a positive impact on communication">the telegraph will have a positive impact on communication</option><option value="the enthusiasm the writer feels for this advance in technology">the enthusiasm the writer feels for this advance in technology</option><option value=" that the impact on commerce will be transformative"> that the impact on commerce will be transformative</option><option value=" that the telegram will be of great advantage to society."> that the telegram will be of great advantage to society.</option><option value=" the writer's vision of a world improved by the connectivity given by the telegram."> the writer's vision of a world improved by the connectivity given by the telegram.</option><option value=" that there will be practical difficulties."> that there will be practical difficulties.</option><option value=" the benefits to how countries will be run."> the benefits to how countries will be run.</option><option value="the importance of the development of this technology.">the importance of the development of this technology.</option><option value=" the author's grand vision."> the author's grand vision.</option><option value="we used to have to rely on horses and boats, which are unreliable.">we used to have to rely on horses and boats, which are unreliable.</option></select></div><div class="bank-group"><span class="bank-label">6. Analysis (From Game)</span><div class="locked-slot"><i class="fas fa-gamepad"></i>&nbsp;Game</div></div><div style="display: flex; gap: 5px; align-self: flex-end;"><button class="btn btn-warning">‚Ü© Undo</button><button class="btn btn-primary">‚¨áÔ∏è Add to Answer</button></div></div>
        <input type="text" id="sentence-stage" placeholder="Answer builds here...">
        <div id="structure-preview">Structure: [starter] + [quote] + [link] + [point] + [analysis]</div>
        <textarea id="answer-area" placeholder="Your full answer..."></textarea>
        <div id="essay-controls" style="display:none; margin-top:10px; justify-content:flex-end; gap:10px;">
            <button class="btn btn-doc" onclick="downloadDoc()">Download Answer (.doc)</button>
            <button class="btn btn-accent" onclick="clearEssay()">Clear</button>
        </div>
    </div>

    <div id="admin-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                Teacher Settings 
                <div>
                    <button class="btn btn-warning" onclick="changePassword()" style="font-size:0.8rem; margin-right:10px;">Change Password</button>
                    <button onclick="closeAdmin()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">√ó</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Text Title:</label><input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" onchange="updateGlobal('question', this.value)">
                </div>

                <div class="editor-section" style="border-left: 5px solid #9c27b0;">
                    <h3>üó£Ô∏è Analysis Phrasing &amp; Grammar</h3>
                    <div id="list-tmpl-tone" class="list-container"><div class="list-item"><input class="list-input" value="which creates a {word} tone" onchange="updateTemplateItem('tone',0,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',0)">X</button></div><div class="list-item"><input class="list-input" value="this evokes a sense of {word}" onchange="updateTemplateItem('tone',1,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',1)">X</button></div><div class="list-item"><input class="list-input" value="this establishes a {word} atmosphere" onchange="updateTemplateItem('tone',2,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',2)">X</button></div><div class="list-item"><input class="list-input" value="which suggests an {adj} tone" onchange="updateTemplateItem('tone',3,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',3)">X</button></div><div class="list-item"><input class="list-input" value="Which evokes a sense of {noun}" onchange="updateTemplateItem('tone',4,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',4)">X</button></div><div class="list-item"><input class="list-input" value="which creates a {adj} tone" onchange="updateTemplateItem('tone',5,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',5)">X</button></div><div class="list-item"><input class="list-input" value="which creates a tone of {noun}" onchange="updateTemplateItem('tone',6,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('tone',6)">X</button></div></div><button class="btn btn-add" onclick="addTemplate('tone')">+ Add Tone Template</button>
                    <div id="list-tmpl-structure" class="list-container" style="margin-top:10px;"><div class="list-item"><input class="list-input" value="structurally highlights {word}" onchange="updateTemplateItem('structure',0,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('structure',0)">X</button></div><div class="list-item"><input class="list-input" value="draws attention to the {word}" onchange="updateTemplateItem('structure',1,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('structure',1)">X</button></div><div class="list-item"><input class="list-input" value="focuses the reader on {word}" onchange="updateTemplateItem('structure',2,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('structure',2)">X</button></div></div><button class="btn btn-add" onclick="addTemplate('structure')">+ Add Structure Template</button>
                    <div id="list-tmpl-language" class="list-container" style="margin-top:10px;"><div class="list-item"><input class="list-input" value="suggests the idea of {word}" onchange="updateTemplateItem('language',0,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('language',0)">X</button></div><div class="list-item"><input class="list-input" value="conveys a feeling of {word}" onchange="updateTemplateItem('language',1,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('language',1)">X</button></div><div class="list-item"><input class="list-input" value="implies that it is {word}" onchange="updateTemplateItem('language',2,this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('language',2)">X</button></div></div><button class="btn btn-add" onclick="addTemplate('language')">+ Add Language Template</button>
                </div>

                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>‚öôÔ∏è Sentence Structure Config</h3>
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                        <select class="admin-input" id="cfg-slot1" onchange="saveStructureConfig()" style="width:auto;"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot2" onchange="saveStructureConfig()" style="width:auto;"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot3" onchange="saveStructureConfig()" style="width:auto;"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot4" onchange="saveStructureConfig()" style="width:auto;"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot5" onchange="saveStructureConfig()" style="width:auto;"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot6" onchange="saveStructureConfig()" style="width:auto;"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                    </div>
                    <button class="btn btn-danger" style="width:100%; margin-top:5px; background:#e74c3c;" onclick="resetSentenceOrder()">‚Ü∫ Reset to Default</button>
                </div>

                <div class="editor-section">
                    <h3>üè¶ Scaffolding Banks</h3>
                    <label><strong>1. Markers</strong></label><div id="list-markers" class="list-container"><div class="list-item"><input class="list-input" value="However," onchange="updateListItem('markers',0,this.value)"><button class="btn btn-danger" onclick="deleteListItem('markers',0)">X</button></div><div class="list-item"><input class="list-input" value="Furthermore," onchange="updateListItem('markers',1,this.value)"><button class="btn btn-danger" onclick="deleteListItem('markers',1)">X</button></div><div class="list-item"><input class="list-input" value="In contrast," onchange="updateListItem('markers',2,this.value)"><button class="btn btn-danger" onclick="deleteListItem('markers',2)">X</button></div><div class="list-item"><input class="list-input" value="Significantly," onchange="updateListItem('markers',3,this.value)"><button class="btn btn-danger" onclick="deleteListItem('markers',3)">X</button></div></div><button class="btn btn-add" onclick="addItem('markers')">+ Add</button>
                    <label style="margin-top:10px;"><strong>2. Starters</strong></label><div id="list-starters" class="list-container"><div class="list-item"><input class="list-input" value="The writer implies" onchange="updateListItem('starters',0,this.value)"><button class="btn btn-danger" onclick="deleteListItem('starters',0)">X</button></div><div class="list-item"><input class="list-input" value="The writer suggests" onchange="updateListItem('starters',1,this.value)"><button class="btn btn-danger" onclick="deleteListItem('starters',1)">X</button></div><div class="list-item"><input class="list-input" value="The writer presents" onchange="updateListItem('starters',2,this.value)"><button class="btn btn-danger" onclick="deleteListItem('starters',2)">X</button></div><div class="list-item"><input class="list-input" value="The writer uses" onchange="updateListItem('starters',3,this.value)"><button class="btn btn-danger" onclick="deleteListItem('starters',3)">X</button></div><div class="list-item"><input class="list-input" value="The writer includes" onchange="updateListItem('starters',4,this.value)"><button class="btn btn-danger" onclick="deleteListItem('starters',4)">X</button></div></div><button class="btn btn-add" onclick="addItem('starters')">+ Add</button>
                    <label style="margin-top:10px;"><strong>3. Methods</strong></label><div id="list-methods" class="list-container"><div class="list-item"><input class="list-input" value="metaphor" onchange="updateListItem('methods',0,this.value)"><button class="btn btn-danger" onclick="deleteListItem('methods',0)">X</button></div><div class="list-item"><input class="list-input" value="simile" onchange="updateListItem('methods',1,this.value)"><button class="btn btn-danger" onclick="deleteListItem('methods',1)">X</button></div><div class="list-item"><input class="list-input" value="juxtaposition" onchange="updateListItem('methods',2,this.value)"><button class="btn btn-danger" onclick="deleteListItem('methods',2)">X</button></div><div class="list-item"><input class="list-input" value="imagery" onchange="updateListItem('methods',3,this.value)"><button class="btn btn-danger" onclick="deleteListItem('methods',3)">X</button></div><div class="list-item"><input class="list-input" value="imperative" onchange="updateListItem('methods',4,this.value)"><button class="btn btn-danger" onclick="deleteListItem('methods',4)">X</button></div><div class="list-item"><input class="list-input" value="hyperbole" onchange="updateListItem('methods',5,this.value)"><button class="btn btn-danger" onclick="deleteListItem('methods',5)">X</button></div></div><button class="btn btn-add" onclick="addItem('methods')">+ Add</button>
                    <label style="margin-top:10px;"><strong>4. Points</strong></label><div id="list-points" class="list-container"><div class="list-item"><input class="list-input" value="the telegraph will have a positive impact on communication" onchange="updateListItem('points',0,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',0)">X</button></div><div class="list-item"><input class="list-input" value="the enthusiasm the writer feels for this advance in technology" onchange="updateListItem('points',1,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',1)">X</button></div><div class="list-item"><input class="list-input" value=" that the impact on commerce will be transformative" onchange="updateListItem('points',2,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',2)">X</button></div><div class="list-item"><input class="list-input" value=" that the telegram will be of great advantage to society." onchange="updateListItem('points',3,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',3)">X</button></div><div class="list-item"><input class="list-input" value=" the writer's vision of a world improved by the connectivity given by the telegram." onchange="updateListItem('points',4,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',4)">X</button></div><div class="list-item"><input class="list-input" value=" that there will be practical difficulties." onchange="updateListItem('points',5,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',5)">X</button></div><div class="list-item"><input class="list-input" value=" the benefits to how countries will be run." onchange="updateListItem('points',6,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',6)">X</button></div><div class="list-item"><input class="list-input" value="the importance of the development of this technology." onchange="updateListItem('points',7,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',7)">X</button></div><div class="list-item"><input class="list-input" value=" the author's grand vision." onchange="updateListItem('points',8,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',8)">X</button></div><div class="list-item"><input class="list-input" value="we used to have to rely on horses and boats, which are unreliable." onchange="updateListItem('points',9,this.value)"><button class="btn btn-danger" onclick="deleteListItem('points',9)">X</button></div></div><button class="btn btn-add" onclick="addItem('points')">+ Add</button>
                    <label style="margin-top:10px;"><strong>5. Links</strong></label><div id="list-links" class="list-container"><div class="list-item"><input class="list-input" value="This reinforces the idea that" onchange="updateListItem('links',0,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',0)">X</button></div><div class="list-item"><input class="list-input" value="linking back to" onchange="updateListItem('links',1,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',1)">X</button></div><div class="list-item"><input class="list-input" value="creating a sense of" onchange="updateListItem('links',2,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',2)">X</button></div><div class="list-item"><input class="list-input" value="which leads us to believe" onchange="updateListItem('links',3,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',3)">X</button></div><div class="list-item"><input class="list-input" value="this makes us aware of" onchange="updateListItem('links',4,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',4)">X</button></div><div class="list-item"><input class="list-input" value=" the writer believes " onchange="updateListItem('links',5,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',5)">X</button></div><div class="list-item"><input class="list-input" value="the writer's conviction" onchange="updateListItem('links',6,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',6)">X</button></div><div class="list-item"><input class="list-input" value="The author can see" onchange="updateListItem('links',7,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',7)">X</button></div><div class="list-item"><input class="list-input" value="which reminds us" onchange="updateListItem('links',8,this.value)"><button class="btn btn-danger" onclick="deleteListItem('links',8)">X</button></div></div><button class="btn btn-add" onclick="addItem('links')">+ Add</button>
                </div>
                
                <div class="editor-section">
                    <h3>Analysis Points (Deep Edit)</h3>
                    <p style="font-size:0.85rem; color:#666;">Use <i class="fas fa-print"></i> to include in Worksheet. Use <i class="fas fa-cut"></i> to force a page break after.</p>
                    <div id="items-container"><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#1 (quote)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" checked="" onchange="updateItemBool(0, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(0, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(0)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(0)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="What kind of tone does the author use with this quote?" placeholder="Question" onchange="updateItem(0,'custom_q',this.value)">
                <input class="admin-input" value="The electric telegraph, a wondrous invention of our age" placeholder="Quote" onchange="updateItem(0,'original',this.value)">
                <div id="details-0" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(0, this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-0" class="lens-group active"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="admiring" onchange="updateDeep(0,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="admiring,scared,encouraging,flattering" onchange="updateDeepOpts(0,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Reverent and laudatory" onchange="updateDeep(0,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="Reverent and laudatory,Objective and formal" onchange="updateDeepOpts(0,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="adulatory, framing the machine as the defining feature of the era." onchange="updateDeep(0,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="adulatory,framing the machine as the defining feature of the era.,castigating using informal slang to make it popular." onchange="updateDeepOpts(0,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-0" class="lens-group "><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Start" onchange="updateDeep(0,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="Start,End" onchange="updateDeepOpts(0,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="An appositive" onchange="updateDeep(0,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="An appositive,An ending" onchange="updateDeepOpts(0,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="The subject is immediately qualified by praise, linking identity to greatness." onchange="updateDeep(0,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="The subject is immediately qualified by praise, linking identity to greatness.,The sentence uses a list of three to show speed." onchange="updateDeepOpts(0,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-0" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Wondrous" onchange="updateDeep(0,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="Wondrous,Electric" onchange="updateDeepOpts(0,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Collective pride in progress" onchange="updateDeep(0,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="Collective pride in progress,Nostalgia for the past" onchange="updateDeepOpts(0,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It establishes a semantic field of the sublime, treating engineering as a miracle." onchange="updateDeep(0,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="It establishes a semantic field of the sublime, treating engineering as a miracle.,It creates a technical tone to explain the wiring." onchange="updateDeepOpts(0,'level3','language',this.value)"></div></div>
                </div>
            </div><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#2 (quote)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" checked="" onchange="updateItemBool(1, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(1, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(1)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(1)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="What is the essential meaning in the phrase" placeholder="Question" onchange="updateItem(1,'custom_q',this.value)">
                <input class="admin-input" value="marvel of instantaneous communication" placeholder="Quote" onchange="updateItem(1,'original',this.value)">
                <div id="details-1" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(1, this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-1" class="lens-group active"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="approving" onchange="updateDeep(1,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="critical" onchange="updateDeepOpts(1,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="commendatory and praiseful" onchange="updateDeep(1,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="commendatory and praiseful,condemnatory and castigating" onchange="updateDeepOpts(1,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="framing a mechanical function as a 'marvel', creating a celebratory feel." onchange="updateDeep(1,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="framing a mechanical function as a 'marvel',creating a celebratory feel.,By using understatement to sound modest." onchange="updateDeepOpts(1,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-1" class="lens-group "><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="After" onchange="updateDeep(1,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="After,Before" onchange="updateDeepOpts(1,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="It moves from naming the machine to explaining its unique power." onchange="updateDeep(1,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="It moves from naming the machine to explaining its unique power.,It repeats the first sentence exactly to show slowness." onchange="updateDeepOpts(1,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="The long word creates a flowing rhythm that contrasts with the meaning of speed." onchange="updateDeep(1,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="The long word creates a flowing rhythm that contrasts with the meaning of speed.,The short, choppy words sound like a ticking clock." onchange="updateDeepOpts(1,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-1" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value=" instant communication is great" onchange="updateDeep(1,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="instant communication is great,everybody talking at the same time is great" onchange="updateDeepOpts(1,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="instant communication is marvelous, " onchange="updateDeep(1,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="instant communication is quite good" onchange="updateDeepOpts(1,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It emphasizes the total removal of time as a barrier to news." onchange="updateDeep(1,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="It emphasizes the total removal of time as a barrier to news.,It suggests the machine is prone to errors." onchange="updateDeepOpts(1,'level3','language',this.value)"></div></div>
                </div>
            </div><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#3 (quote)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" checked="" onchange="updateItemBool(2, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(2, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(2)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(2)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="What is implied by the phrase" placeholder="Question" onchange="updateItem(2,'custom_q',this.value)">
                <input class="admin-input" value="No longer confined" placeholder="Quote" onchange="updateItem(2,'original',this.value)">
                <div id="details-2" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(2, this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-2" class="lens-group active"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Freedom" onchange="updateDeep(2,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="Freedom," onchange="updateDeepOpts(2,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Liberation" onchange="updateDeep(2,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="Liberation,Restriction" onchange="updateDeepOpts(2,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It creates a triumphant tone by dismissing previous limits." onchange="updateDeep(2,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="It creates a triumphant tone by dismissing previous limits.,It creates a cynical tone about the future." onchange="updateDeepOpts(2,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-2" class="lens-group "><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Negative (No)" onchange="updateDeep(2,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="Negative (No),Positive (Yes)" onchange="updateDeepOpts(2,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="A discourse marker" onchange="updateDeep(2,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="A discourse marker,A full stop" onchange="updateDeepOpts(2,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It creates a pivot point that discredits history to prioritize the present." onchange="updateDeep(2,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="It creates a pivot point that discredits history to prioritize the present.,It creates a repetitive rhythm to show boredom." onchange="updateDeepOpts(2,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-2" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Trapped" onchange="updateDeep(2,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="Trapped,Free" onchange="updateDeepOpts(2,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Like a cage" onchange="updateDeep(2,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="Like a cage,A cozy home" onchange="updateDeepOpts(2,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It personifies communication as a captive that has been freed by technology." onchange="updateDeep(2,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="It personifies communication as a captive that has been freed by technology.,It suggests the telegraph is kept in a prison." onchange="updateDeepOpts(2,'level3','language',this.value)"></div></div>
                </div>
            </div><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#4 (quote)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" checked="" onchange="updateItemBool(3, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" checked="" onchange="updateItemBool(3, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(3)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(3)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="Why does the author use" placeholder="Question" onchange="updateItem(3,'custom_q',this.value)">
                <input class="admin-input" value="slow and uncertain services of horse and ship" placeholder="Quote" onchange="updateItem(3,'original',this.value)">
                <div id="details-3" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(3, this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-3" class="lens-group active"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="comparitive" onchange="updateDeep(3,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="comparative,Critical,Nostalgic" onchange="updateDeepOpts(3,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Comparative and appreciative" onchange="updateDeep(3,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="Dismissive,sarcastic," onchange="updateDeepOpts(3,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="By selecting negative adjectives that highlight delay and failure." onchange="updateDeep(3,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="By selecting negative adjectives that highlight delay and failure.,By making the horses sound like noble creatures." onchange="updateDeepOpts(3,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-3" class="lens-group "><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Horse" onchange="updateDeep(3,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="Horse,Ship" onchange="updateDeepOpts(3,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="It groups all old methods together as outdated." onchange="updateDeep(3,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="It groups all old methods together as outdated.,It shows the writer likes animals." onchange="updateDeepOpts(3,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It creates a 'before' image to heighten the 'after' effect of the telegraph." onchange="updateDeep(3,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="It creates a 'before' image to heighten the 'after' effect of the telegraph.,It provides a conclusion to the argument." onchange="updateDeepOpts(3,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-3" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Uncertain" onchange="updateDeep(3,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="Uncertain,Slow" onchange="updateDeepOpts(3,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Frustration with the past" onchange="updateDeep(3,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="Frustration with the past,Peace and quiet" onchange="updateDeepOpts(3,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It highlights the shift from physical transport to instant transmission." onchange="updateDeep(3,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="It highlights the shift from physical transport to instant transmission.,It suggests horses are safer than wires." onchange="updateDeepOpts(3,'level3','language',this.value)"></div></div>
                </div>
            </div><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#5 (quote)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" checked="" onchange="updateItemBool(4, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(4, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(4)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(4)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="What does this quote mean?" placeholder="Question" onchange="updateItem(4,'custom_q',this.value)">
                <input class="admin-input" value="defying previous conceptions of time and space" placeholder="Quote" onchange="updateItem(4,'original',this.value)">
                <div id="details-4" class="analysis-details" style="display: block;">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(4, this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-4" class="lens-group"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Awe and Admiration" onchange="updateDeep(4,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="Strong,Weak" onchange="updateDeepOpts(4,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Triumphant" onchange="updateDeep(4,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="Triumphant,Hesitant" onchange="updateDeepOpts(4,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It shows absolute confidence in human dominance over nature." onchange="updateDeep(4,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="It shows absolute confidence in human dominance over nature.,It reveals a subtle fear of technology." onchange="updateDeepOpts(4,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-4" class="lens-group active"><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Short and punchy" onchange="updateDeep(4,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="Short and punchy,Long story" onchange="updateDeepOpts(4,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="The brevity of the phrase reflects the speed of the telegraph." onchange="updateDeep(4,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="The brevity of the phrase reflects the speed of the telegraph.,The long sentence shows distance." onchange="updateDeepOpts(4,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It acts as a final declaration of superiority over natural laws." onchange="updateDeep(4,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="It acts as a final declaration of superiority over natural laws.,It is hidden to make it sound less important." onchange="updateDeepOpts(4,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-4" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="Destroy completely" onchange="updateDeep(4,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="Destroy completely,Fix" onchange="updateDeepOpts(4,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="Hyperbole (exaggeration)" onchange="updateDeep(4,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="Hyperbole (exaggeration),A simile" onchange="updateDeepOpts(4,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It emphasizes that the telegraph's impact is a total revolution, not a minor change." onchange="updateDeep(4,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="It emphasizes that the telegraph's impact is a total revolution, not a minor change.,It suggests the telegraph is a weapon." onchange="updateDeepOpts(4,'level3','language',this.value)"></div></div>
                </div>
            </div><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#6 (structure)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(5, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(5, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(5)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(5)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="How does the the focus of the text change over the whole piece?" placeholder="Question" onchange="updateItem(5,'custom_q',this.value)">
                <input class="admin-input" value="The whole piece" placeholder="Quote" onchange="updateItem(5,'original',this.value)">
                <div id="details-5" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(5, this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure" selected="">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-5" class="lens-group "><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="" onchange="updateDeep(5,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(5,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="" onchange="updateDeep(5,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(5,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="" onchange="updateDeep(5,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(5,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-5" class="lens-group active"><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="It starts with one machine and ends with the whole world." onchange="updateDeep(5,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="It starts with one machine and ends with the whole world.,It stays focused only on the machine." onchange="updateDeepOpts(5,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="The 'zooming out' from an invention to its global impact." onchange="updateDeep(5,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="The 'zooming out' from an invention to its global impact.,The use of a marker like 'However' to change topics." onchange="updateDeepOpts(5,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="The writer creates a thematic link suggesting science leads to world peace." onchange="updateDeep(5,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="The writer creates a thematic link suggesting science leads to world peace.,The writer uses a circular structure to return to the machine details." onchange="updateDeepOpts(5,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-5" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="" onchange="updateDeep(5,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(5,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="" onchange="updateDeep(5,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(5,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="" onchange="updateDeep(5,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(5,'level3','language',this.value)"></div></div>
                </div>
            </div><div class="editor-section">
                <div style="display:flex;justify-content:space-between;"><strong>#7 (structure)</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(6, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" onchange="updateItemBool(6, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(6)"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(6)"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="How does the first paragraph reflect the whole article?" placeholder="Question" onchange="updateItem(6,'custom_q',this.value)">
                <input class="admin-input" value="The first paragraph" placeholder="Quote" onchange="updateItem(6,'original',this.value)">
                <div id="details-6" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(6, this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure" selected="">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-6" class="lens-group "><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="" onchange="updateDeep(6,'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(6,'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="" onchange="updateDeep(6,'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(6,'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="" onchange="updateDeep(6,'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(6,'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-6" class="lens-group active"><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="It moves from horses to wires" onchange="updateDeep(6,'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="It moves from horses to wires,IT moves from wires to horses" onchange="updateDeepOpts(6,'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="It creates a sharp contrast between 'old' and 'new'." onchange="updateDeep(6,'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="It creates a sharp contrast between 'old' and 'new'.,It shows they are both equal in speed." onchange="updateDeepOpts(6,'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="It uses binary opposition to dismiss history and promote the present." onchange="updateDeep(6,'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="It uses binary opposition to dismiss history and promote the present.,It uses a circular structure to show history repeats." onchange="updateDeepOpts(6,'level3','structure',this.value)"></div></div>
                    <div id="lens-language-6" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="" onchange="updateDeep(6,'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(6,'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="" onchange="updateDeep(6,'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(6,'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="" onchange="updateDeep(6,'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="" onchange="updateDeepOpts(6,'level3','language',this.value)"></div></div>
                </div>
            </div></div>
                    <button class="btn btn-add" onclick="addNewItem()">+ Add New Analysis Point</button>
                </div>

                <div style="margin-top:20px; padding:15px; background:#e3f2fd; border-radius:5px;">
                    <h3>üíæ Data &amp; Distribution</h3>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button class="btn btn-doc" onclick="downloadJSON()">Save Settings JSON</button>
                        <button class="btn btn-doc" onclick="document.getElementById('file-up').click()">Load Settings JSON</button>
                        <input type="file" id="file-up" style="display:none;" onchange="uploadJSON(this)">
                    </div>
                    
                    <div style="padding:15px; border:2px dashed var(--primary); border-radius:5px; background:white; margin-bottom:15px; text-align:left;">
                        <strong>üöÄ Share with Students</strong><br>
                        <button class="btn btn-primary" style="width:100%; margin-top:5px;" onclick="downloadStudentApp()">üì¶ Download Class App (.html)</button>
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <label style="font-size:0.9rem; font-weight:bold;">Generate QR Code:</label>
                            <input class="admin-input" id="qr-input" placeholder="Paste your hosted link (e.g. https://...)" oninput="generateQR(this.value)">
                            <div id="qr-display" style="margin-top:10px; text-align:center; min-height:150px; display:flex; align-items:center; justify-content:center; background:#f9f9f9; border:1px solid #ddd;">
                                <span style="color:#ccc;">QR will appear here</span>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <p style="margin-bottom:5px; font-weight:bold;">Select Level to Print:</p>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <select id="ws-print-mode" class="admin-input" style="width:auto; flex-grow:1;">
                            <option value="all">Merged (Use Checkboxes)</option>
                            <option value="1">Level 1 Only</option>
                            <option value="2">Level 2 Only</option>
                            <option value="3">Level 3 Only</option>
                        </select>
                        <button class="btn btn-accent" onclick="downloadWorksheetDoc()">üìù Download Worksheet (.doc)</button>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <label><input type="checkbox" id="ws-lvl1" checked="" onchange="saveWSOptions()"> Incl. L1</label>
                        <label><input type="checkbox" id="ws-lvl2" checked="" onchange="saveWSOptions()"> Incl. L2</label>
                        <label><input type="checkbox" id="ws-lvl3" checked="" onchange="saveWSOptions()"> Incl. L3</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="phrasing-overlay" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Select Phrasing</div>
            <div class="modal-body">
                <p>You chose: <strong id="phrase-word" style="color:var(--primary);"></strong></p>
                <div id="phrase-options"></div>
            </div>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

<script>
    // Dictionary & Defaults (Same as v54)
    const wordMorphology = { "admiring":{adj:"admiring",noun:"admiration",verb:"admires"}, "angry":{adj:"angry",noun:"anger",verb:"angers"}, "anxious":{adj:"anxious",noun:"anxiety",verb:"worries"}, "chaotic":{adj:"chaotic",noun:"chaos",verb:"disrupts"}, "critical":{adj:"critical",noun:"criticism",verb:"criticizes"}, "cyclical":{adj:"cyclical",noun:"cyclical structure",verb:"cycles"}, "desperate":{adj:"desperate",noun:"desperation",verb:"despairs"}, "enthusiastic":{adj:"enthusiastic",noun:"enthusiasm",verb:"enthuses"}, "fearful":{adj:"fearful",noun:"fear",verb:"fears"}, "gloomy":{adj:"gloomy",noun:"gloom",verb:"saddens"}, "hopeful":{adj:"hopeful",noun:"hope",verb:"hopes"}, "hostile":{adj:"hostile",noun:"hostility",verb:"attacks"}, "joyful":{adj:"joyful",noun:"joy",verb:"rejoices"}, "melancholy":{adj:"melancholic",noun:"melancholy",verb:"saddens"}, "nostalgic":{adj:"nostalgic",noun:"nostalgia",verb:"remembers"}, "ominous":{adj:"ominous",noun:"foreboding",verb:"threatens"}, "peaceful":{adj:"peaceful",noun:"peace",verb:"calms"}, "tense":{adj:"tense",noun:"tension",verb:"tenses"} };
    const defaultData = {"textTitle":"The Electric Telegraph","question":"How does the writer try to show the impact the electric telegraph could have on communication?","adminPassword":"qwer","sentenceOrder":["starter","quote","none","link","point","analysis"],"worksheetOptions":{"lvl1":true,"lvl2":false,"lvl3":false},"analysisTemplates":{"tone":["which creates a {word} tone","this evokes a sense of {word}","this establishes a {word} atmosphere","which suggests an {adj} tone","Which evokes a sense of {noun}","which creates a {adj} tone","which creates a tone of {noun}"],"structure":["structurally highlights {word}","draws attention to the {word}","focuses the reader on {word}"],"language":["suggests the idea of {word}","conveys a feeling of {word}","implies that it is {word}"]},"markers":["However,","Furthermore,","In contrast,","Significantly,"],"starters":["The writer implies","The writer suggests","The writer presents","The writer uses","The writer includes"],"points":["the telegraph will have a positive impact on communication","the enthusiasm the writer feels for this advance in technology"," that the impact on commerce will be transformative"," that the telegram will be of great advantage to society."," the writer's vision of a world improved by the connectivity given by the telegram."," that there will be practical difficulties."," the benefits to how countries will be run.","the importance of the development of this technology."," the author's grand vision.","we used to have to rely on horses and boats, which are unreliable."],"methods":["metaphor","simile","juxtaposition","imagery","imperative","hyperbole"],"links":["This reinforces the idea that","linking back to","creating a sense of","which leads us to believe","this makes us aware of"," the writer believes ","the writer's conviction","The author can see","which reminds us"],"items":[{"id":"q1","type":"quote","original":"The electric telegraph, a wondrous invention of our age","translation":"The electric telegraph is an amazing invention of our modern time.","distractors":["The telegraph is a confusing scientific experiment.","The telegraph is a dangerous machine that shocks people.","The telegraph is an expensive tool for the elite."],"level1":{"tone":{"prompt":"How does the writer feel about the telegraph?","correct":"admiring","options":["admiring","scared","encouraging","flattering"]},"structure":{"prompt":"Is this phrase at the start or end of the text?","correct":"Start","options":["Start","End"]},"language":{"prompt":"Which word makes the telegraph sound like a miracle?","correct":"Wondrous","options":["Wondrous","Electric"]}},"level2":{"tone":{"prompt":"The tone of the opening is best described as:","correct":"Reverent and laudatory","options":["Reverent and laudatory","Objective and formal"]},"structure":{"prompt":"The description 'a wondrous invention' is placed in commas. This is called:","correct":"An appositive","options":["An appositive","An ending"]},"language":{"prompt":"The writer uses the phrase 'our age' to show:","correct":"Collective pride in progress","options":["Collective pride in progress","Nostalgia for the past"]}},"level3":{"tone":{"prompt":"How does the writer establish a tone of epochal importance?","correct":"adulatory, framing the machine as the defining feature of the era.","options":["adulatory","framing the machine as the defining feature of the era.","castigating using informal slang to make it popular."]},"structure":{"prompt":"Analyze the syntax of the opening clause.","correct":"The subject is immediately qualified by praise, linking identity to greatness.","options":["The subject is immediately qualified by praise, linking identity to greatness.","The sentence uses a list of three to show speed."]},"language":{"prompt":"Analyze the effect of the emotive adjective 'wondrous'.","correct":"It establishes a semantic field of the sublime, treating engineering as a miracle.","options":["It establishes a semantic field of the sublime, treating engineering as a miracle.","It creates a technical tone to explain the wiring."]}},"custom_q":"What kind of tone does the author use with this quote?","includeInWS":true},{"id":"q2","type":"quote","original":"marvel of instantaneous communication","translation":"The amazing miracle of sending messages at the same moment.","distractors":["A  way to send messages through wires.","Messages that will insist on being received.","A scientific description of electrical current."],"level1":{"tone":{"prompt":"Does the writer think the speed is good or bad?","correct":"approving","options":["critical"]},"structure":{"prompt":"Does this detail come before or after the name of the invention?","correct":"After","options":["After","Before"]},"language":{"prompt":"Which word means 'happening straight away'?","correct":" instant communication is great","options":["instant communication is great","everybody talking at the same time is great"]}},"level2":{"tone":{"prompt":"The tone regarding the telegraph's speed is one of:","correct":"commendatory and praiseful","options":["commendatory and praiseful","condemnatory and castigating"]},"structure":{"prompt":"How does this phrase develop the text's opening idea?","correct":"It moves from naming the machine to explaining its unique power.","options":["It moves from naming the machine to explaining its unique power.","It repeats the first sentence exactly to show slowness."]},"language":{"prompt":"The noun 'marvel' elevates the telegraph to:","correct":"instant communication is marvelous, ","options":["instant communication is quite good"]}},"level3":{"tone":{"prompt":"How does the writer use hyperbole to affect the tone?","correct":"framing a mechanical function as a 'marvel', creating a celebratory feel.","options":["framing a mechanical function as a 'marvel'","creating a celebratory feel.","By using understatement to sound modest."]},"structure":{"prompt":"Evaluate the rhythmic effect of the polysyllabic 'instantaneous'.","correct":"The long word creates a flowing rhythm that contrasts with the meaning of speed.","options":["The long word creates a flowing rhythm that contrasts with the meaning of speed.","The short, choppy words sound like a ticking clock."]},"language":{"prompt":"Analyze the impact of the adjective 'instantaneous'.","correct":"It emphasizes the total removal of time as a barrier to news.","options":["It emphasizes the total removal of time as a barrier to news.","It suggests the machine is prone to errors."]}},"custom_q":"What is the essential meaning in the phrase","includeInWS":true},{"id":"q3","type":"quote","original":"No longer confined","translation":"There used to be no other alternative, but now there is a much better one.","distractors":["It is no longer safe to use.","It is no longer allowed to move freely.","It is no longer kept in a small office."],"level1":{"tone":{"prompt":"Does this sound like freedom or a prison?","correct":"Freedom","options":["Freedom",""]},"structure":{"prompt":"Does this phrase start with a positive or a negative word?","correct":"Negative (No)","options":["Negative (No)","Positive (Yes)"]},"language":{"prompt":"What does 'confined' mean?","correct":"Trapped","options":["Trapped","Free"]}},"level2":{"tone":{"prompt":"The tone of 'No longer confined' implies:","correct":"Liberation","options":["Liberation","Restriction"]},"structure":{"prompt":"The use of 'No longer' at the start of the clause acts as:","correct":"A discourse marker","options":["A discourse marker","A full stop"]},"language":{"prompt":"The word 'confined' is a metaphor that suggests the past was:","correct":"Like a cage","options":["Like a cage","A cozy home"]}},"level3":{"tone":{"prompt":"How does this negative construction ('No longer') shape the tone?","correct":"It creates a triumphant tone by dismissing previous limits.","options":["It creates a triumphant tone by dismissing previous limits.","It creates a cynical tone about the future."]},"structure":{"prompt":"Evaluate the structural use of negation to develop the argument.","correct":"It creates a pivot point that discredits history to prioritize the present.","options":["It creates a pivot point that discredits history to prioritize the present.","It creates a repetitive rhythm to show boredom."]},"language":{"prompt":"Analyze the connotations of 'confined'.","correct":"It personifies communication as a captive that has been freed by technology.","options":["It personifies communication as a captive that has been freed by technology.","It suggests the telegraph is kept in a prison."]}},"custom_q":"What is implied by the phrase","includeInWS":true},{"id":"q4","type":"quote","original":"slow and uncertain services of horse and ship","translation":"The old, untrustworthy ways using animals and boats.","distractors":["The fast and reliable old travel methods.","The beautiful and majestic ships of the past.","The healthy and fast horses used for post."],"level1":{"tone":{"prompt":"How does the writer feel about horses and ships?","correct":"comparitive","options":["comparative","Critical","Nostalgic"]},"structure":{"prompt":"Does the writer mention horses or ships first?","correct":"Horse","options":["Horse","Ship"]},"language":{"prompt":"Which word shows that horses/ships were not reliable?","correct":"Uncertain","options":["Uncertain","Slow"]}},"level2":{"tone":{"prompt":"The tone regarding previous methods is best described as:","correct":"Comparative and appreciative","options":["Dismissive","sarcastic",""]},"structure":{"prompt":"How does this list of two ('horse and ship') affect the reader?","correct":"It groups all old methods together as outdated.","options":["It groups all old methods together as outdated.","It shows the writer likes animals."]},"language":{"prompt":"The adjectives 'slow and uncertain' create a sense of:","correct":"Frustration with the past","options":["Frustration with the past","Peace and quiet"]}},"level3":{"tone":{"prompt":"Analyze how the writer discredits history through tone.","correct":"By selecting negative adjectives that highlight delay and failure.","options":["By selecting negative adjectives that highlight delay and failure.","By making the horses sound like noble creatures."]},"structure":{"prompt":"How does this specific list contribute to the arc of the extract?","correct":"It creates a 'before' image to heighten the 'after' effect of the telegraph.","options":["It creates a 'before' image to heighten the 'after' effect of the telegraph.","It provides a conclusion to the argument."]},"language":{"prompt":"Analyze the juxtaposition of 'slow/uncertain' with the implied speed of electricity.","correct":"It highlights the shift from physical transport to instant transmission.","options":["It highlights the shift from physical transport to instant transmission.","It suggests horses are safer than wires."]}},"custom_q":"Why does the author use","includeInWS":true,"pageBreak":true},{"id":"q5","type":"quote","original":"defying previous conceptions of time and space","translation":"To completely destroy the wait and the distance.","distractors":["To break all the clocks in the world.","To physically shrink the Earth.","To cause an explosion with wires."],"level1":{"tone":{"prompt":"Does 'annihilate' sound weak or strong?","correct":"Awe and Admiration","options":["Strong","Weak"]},"structure":{"prompt":"Is this a short, punchy phrase or a long story?","correct":"Short and punchy","options":["Short and punchy","Long story"]},"language":{"prompt":"What does 'annihilate' mean?","correct":"Destroy completely","options":["Destroy completely","Fix"]}},"level2":{"tone":{"prompt":"The tone created by the verb 'annihilate' is:","correct":"Triumphant","options":["Triumphant","Hesitant"]},"structure":{"prompt":"How does the syntax mirror the meaning here?","correct":"The brevity of the phrase reflects the speed of the telegraph.","options":["The brevity of the phrase reflects the speed of the telegraph.","The long sentence shows distance."]},"language":{"prompt":"The use of 'annihilate' is an example of:","correct":"Hyperbole (exaggeration)","options":["Hyperbole (exaggeration)","A simile"]}},"level3":{"tone":{"prompt":"Evaluate how this tone reflects Victorian attitudes.","correct":"It shows absolute confidence in human dominance over nature.","options":["It shows absolute confidence in human dominance over nature.","It reveals a subtle fear of technology."]},"structure":{"prompt":"Evaluate the structural positioning of this claim.","correct":"It acts as a final declaration of superiority over natural laws.","options":["It acts as a final declaration of superiority over natural laws.","It is hidden to make it sound less important."]},"language":{"prompt":"Analyze the impact of using a violent verb like 'annihilate'.","correct":"It emphasizes that the telegraph's impact is a total revolution, not a minor change.","options":["It emphasizes that the telegraph's impact is a total revolution, not a minor change.","It suggests the telegraph is a weapon."]}},"custom_q":"What does this quote mean?","includeInWS":true},{"id":"s1","type":"structure","label":"Opening vs Ending","detail":"The text moves from a technical machine to a global vision of unity.","distractors":["The text moves from London to a ship at sea.","The text shifts from a focus on wires to a focus on money.","The text starts with a story and ends with a list."],"level1":{"structure":{"prompt":"How does the focus change from the start to the end?","correct":"It starts with one machine and ends with the whole world.","options":["It starts with one machine and ends with the whole world.","It stays focused only on the machine."]}},"level2":{"structure":{"prompt":"Identify the primary structural link between the opening and the conclusion:","correct":"The 'zooming out' from an invention to its global impact.","options":["The 'zooming out' from an invention to its global impact.","The use of a marker like 'However' to change topics."]}},"level3":{"structure":{"prompt":"Evaluate the macro-structure: the link between 'astonishment' and 'unity'.","correct":"The writer creates a thematic link suggesting science leads to world peace.","options":["The writer creates a thematic link suggesting science leads to world peace.","The writer uses a circular structure to return to the machine details."]}},"original":"The whole piece","custom_q":"How does the the focus of the text change over the whole piece?"},{"id":"s2","type":"structure","label":"The Past vs Present Shift","detail":"The shift from describing horses/ships to describing electricity.","distractors":["It starts with the problem, then moves to the solution","It just talks about the electric telegraph on its own.","It talks mostly about the problem of having to use horses and ships"],"level1":{"structure":{"prompt":"Does the text move from slow things to fast things?","correct":"It moves from horses to wires","options":["It moves from horses to wires","IT moves from wires to horses"]}},"level2":{"structure":{"prompt":"How does this juxtaposition help the writer's argument?","correct":"It creates a sharp contrast between 'old' and 'new'.","options":["It creates a sharp contrast between 'old' and 'new'.","It shows they are both equal in speed."]}},"level3":{"structure":{"prompt":"Analyze the structural arc of this comparison.","correct":"It uses binary opposition to dismiss history and promote the present.","options":["It uses binary opposition to dismiss history and promote the present.","It uses a circular structure to show history repeats."]}},"custom_q":"How does the first paragraph reflect the whole article?","translation":"It introduces the subject then shifts from describing horses/ships to describing electricity.","original":"The first paragraph"}]};
    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: 0, filter: 'all', completed: [] };
    let sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };

    function init() {
        let local = localStorage.getItem('tsa_v55_ctrl');
        if(!local) { local = localStorage.getItem('tsa_v54_qr'); }
        if(local) {
            try { 
                const saved = JSON.parse(local);
                appData = { ...defaultData, ...saved };
                // Ensure new props exist
                appData.items.forEach(i => { if(i.includeInWS === undefined) i.includeInWS = true; if(i.pageBreak === undefined) i.pageBreak = false; });
            } catch(e) { appData = defaultData; }
        }
        if(document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', runStartup); } else { runStartup(); }
    }
    
    function runStartup() { state.currentIdx = -1; state.completed = []; updateUI(); loadStageSelect(); }
    function hardReset() { if(confirm("Factory Reset?")) { localStorage.removeItem('tsa_v55_ctrl'); location.reload(); } }
    function updateUI() { document.getElementById('text-display').innerText = appData.textTitle; document.getElementById('q-display').innerText = appData.question; renderBuilderUI(); }
    function requestAdminAccess() { const input = prompt("Enter Admin Password:"); if (input === appData.adminPassword) { openAdmin(); } else { alert("Incorrect Password."); } }
    function changePassword() { const newPass = prompt("Enter new password:"); if(newPass && newPass.trim() !== "") { appData.adminPassword = newPass.trim(); saveLocal(); alert("Password changed."); } }
    function generateQR(url) { const display = document.getElementById('qr-display'); if(!url || url.trim() === "") { display.innerHTML = '<span style="color:#ccc;">QR will appear here</span>'; return; } display.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}" alt="QR Code" style="border:5px solid white;">`; }
    function getMorphology(word, type) { const lower = word.toLowerCase(); const entry = wordMorphology[lower]; if (entry && entry[type]) return entry[type]; if (type === 'noun') { if (lower.endsWith('ing')) return lower.replace('ing', 'ion'); if (lower.endsWith('ent')) return lower.replace('ent', 'ence'); if (lower.endsWith('ous')) return lower.replace('ous', 'ness'); } return lower; }
    function applyGrammarRules(text) { return text.replace(/\b(a)\s([aeiou])/g, "an $2"); }

    function renderBuilderUI() {
        const container = document.getElementById('dynamic-builder-controls'); if(!container) return; container.innerHTML = '';
        let previewStr = "";
        appData.sentenceOrder.forEach((type, index) => {
            if(type === 'none') return;
            previewStr += `[${type}] + `;
            const group = document.createElement('div'); group.className = 'bank-group';
            let labelText = type.charAt(0).toUpperCase() + type.slice(1);
            if(type === 'quote') labelText = "Quote (From Card)";
            if(type === 'analysis') labelText = "Analysis (From Game)";
            const label = document.createElement('span'); label.className = 'bank-label'; label.innerText = `${index+1}. ${labelText}`; group.appendChild(label);
            if(type === 'quote' || type === 'analysis') {
                const placeholder = document.createElement('div'); placeholder.className = 'locked-slot';
                placeholder.innerHTML = type === 'quote' ? `<i class="fas fa-quote-right"></i>&nbsp;Quote` : `<i class="fas fa-gamepad"></i>&nbsp;Game`;
                if(sentenceSlots[type]) { placeholder.style.background = '#c8e6c9'; placeholder.style.color = '#2e7d32'; placeholder.innerHTML = `<i class="fas fa-check"></i> ${type}`; }
                group.appendChild(placeholder);
            } else {
                const select = document.createElement('select'); select.className = 'bank-select'; select.id = `sel-${type}`; select.onchange = () => updateSlot(type); select.innerHTML = `<option value="">‚ûï ${labelText}</option>`;
                if(appData[type+'s']) appData[type+'s'].forEach(opt => select.add(new Option(opt, opt)));
                group.appendChild(select);
            }
            container.appendChild(group);
        });
        document.getElementById('structure-preview').innerText = "Structure: " + previewStr.slice(0, -3);
        const btnGroup = document.createElement('div'); btnGroup.style.display = 'flex'; btnGroup.style.gap = '5px'; btnGroup.style.alignSelf = 'flex-end';
        const btnUndo = document.createElement('button'); btnUndo.className = 'btn btn-warning'; btnUndo.onclick = undoLast; btnUndo.innerHTML = '‚Ü© Undo';
        const btnAdd = document.createElement('button'); btnAdd.className = 'btn btn-primary'; btnAdd.onclick = commitSentence; btnAdd.innerHTML = '‚¨áÔ∏è Add to Answer';
        btnGroup.appendChild(btnUndo); btnGroup.appendChild(btnAdd); container.appendChild(btnGroup);
    }

    function updateSlot(type) { const el = document.getElementById(`sel-${type}`); if(el && el.value) { sentenceSlots[type] = el.value; rebuildSentenceBox(); el.value = ""; } }
    function undoLast() { let order = [...appData.sentenceOrder].reverse(); for(let key of order) { if(sentenceSlots[key]) { sentenceSlots[key] = ""; rebuildSentenceBox(); return; } } }
    function rebuildSentenceBox() {
        let parts = []; appData.sentenceOrder.forEach(type => { if(type !== 'none' && sentenceSlots[type]) { parts.push(sentenceSlots[type]); } });
        if(sentenceSlots.analysis && !appData.sentenceOrder.includes('analysis')) parts.push(sentenceSlots.analysis);
        let fullSentence = parts.join(" "); fullSentence = applyGrammarRules(fullSentence);
        if(fullSentence.length > 0) { fullSentence = fullSentence.charAt(0).toUpperCase() + fullSentence.slice(1); }
        document.getElementById('sentence-stage').value = fullSentence.trim(); renderBuilderUI();
    }
    function changeLevel() { state.level = parseInt(document.getElementById('level-select').value); loadStageSelect(); }
    function filterGrid(type, btn) { state.filter = type; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadStageSelect(); }

    function loadStageSelect() {
        document.querySelectorAll('.stage').forEach(e=>e.classList.remove('active')); document.getElementById('stage-select').classList.add('active');
        const grid = document.getElementById('grid-main'); if(!grid) return; grid.innerHTML = '';
        if(!appData.items) return;
        let availableCount = 0;
        appData.items.forEach((item, i) => {
            if(state.completed.includes(i)) return; 
            if(state.filter === 'structure' && item.type !== 'structure') return;
            if(state.filter === 'language' && item.type === 'structure') return;
            availableCount++;
            const div = document.createElement('div'); div.className = item.type === 'structure' ? 'card card-struct' : 'card card-lang';
            const mainText = item.type==='structure' ? item.label : '"'+item.original+'"';
            const subText = item.custom_q ? item.custom_q : (item.type==='structure' ? item.detail : "Analyze this quote");
            div.innerHTML = `<strong>${item.type==='structure'?'üèóÔ∏è':'üî§'} ${mainText}</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">${subText}</small>`;
            div.onclick = () => { state.currentIdx = i; document.getElementById('dynamic-question-display').innerText = item.custom_q || "Analyzing Evidence"; item.type==='structure'?loadAnalysis('structure'):loadDecoder(); };
            grid.appendChild(div);
        });
        if(availableCount === 0 && appData.items.length > 0) { grid.innerHTML = `<div style="grid-column:1/-1; text-align:center;"><h3>üéâ Analysis Complete!</h3><button class="btn btn-accent" onclick="runStartup()">Start Over</button></div>`; }
        sentenceSlots.quote = ""; sentenceSlots.analysis = ""; rebuildSentenceBox();
    }

    function loadDecoder() {
        document.getElementById('stage-select').classList.remove('active'); document.getElementById('stage-decoder').classList.add('active');
        const item = appData.items[state.currentIdx]; document.getElementById('decoder-quote').innerText = item.original;
        const grid = document.getElementById('grid-decoder'); grid.innerHTML = '';
        let opts = [{txt: item.translation, correct:true}]; if(item.distractors) item.distractors.forEach(d => opts.push({txt: d, correct:false}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div'); btn.className = 'card'; btn.innerText = opt.txt;
            btn.onclick = () => { if(opt.correct) { sentenceSlots.quote = `"${item.original}"`; rebuildSentenceBox(); document.getElementById('stage-decoder').classList.remove('active'); document.getElementById('stage-lens').classList.add('active'); } else alert("Try again."); };
            grid.appendChild(btn);
        });
    }

    function loadAnalysis(lens) {
        const item = appData.items[state.currentIdx]; const lvlKey = 'level'+state.level;
        if(!item[lvlKey] || !item[lvlKey][lens]) { alert("No data for this level."); return; }
        document.getElementById('stage-lens').classList.remove('active'); document.getElementById('stage-analysis').classList.add('active');
        const data = item[lvlKey][lens]; document.getElementById('analysis-prompt').innerText = data.prompt;
        const grid = document.getElementById('grid-analysis'); grid.innerHTML = '';
        let rawOptions = data.options ? [...data.options] : [];
        if(data.correct && !rawOptions.includes(data.correct)) rawOptions.push(data.correct);
        let opts = rawOptions.map(o => ({txt:o, correct: o===data.correct}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div'); btn.className = 'card ' + (lens==='tone'?'card-tone':lens==='structure'?'card-struct':'card-lang'); btn.innerText = opt.txt;
            btn.onclick = () => { if(opt.correct) { showPhrasingSelector(lens, opt.txt.toLowerCase()); } else alert("Try again."); };
            grid.appendChild(btn);
        });
    }

    function showPhrasingSelector(lens, word) {
        const modal = document.getElementById('phrasing-overlay'); const container = document.getElementById('phrase-options');
        document.getElementById('phrase-word').innerText = word; container.innerHTML = '';
        let templates = appData.analysisTemplates[lens] || ["creates a {adj} tone"];
        templates.forEach(t => {
            let filled = t;
            if (t.includes("{noun}")) filled = filled.replace("{noun}", getMorphology(word, 'noun'));
            if (t.includes("{adj}")) filled = filled.replace("{adj}", getMorphology(word, 'adj'));
            if (t.includes("{verb}")) filled = filled.replace("{verb}", getMorphology(word, 'verb'));
            if (t.includes("{word}")) filled = filled.replace("{word}", word);
            const btn = document.createElement('div'); btn.className = 'phrase-option'; btn.innerText = filled;
            btn.onclick = () => { sentenceSlots.analysis = filled; rebuildSentenceBox(); modal.style.display = 'none'; document.getElementById('overlay-msg').style.display='flex'; setTimeout(() => { document.getElementById('overlay-msg').style.display='none'; }, 1000); };
            container.appendChild(btn);
        });
        modal.style.display = 'flex';
    }

    function commitSentence() {
        const val = document.getElementById('sentence-stage').value; if(!val) return;
        const area = document.getElementById('answer-area'); area.style.display='block';
        document.getElementById('essay-controls').style.display='flex'; area.value += (area.value ? "\n\n" : "") + val;
        if(state.currentIdx !== -1) state.completed.push(state.currentIdx);
        sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };
        document.getElementById('sentence-stage').value = ""; loadStageSelect();
    }
    function clearEssay() { if(confirm("Clear answer?")) { document.getElementById('answer-area').value=""; } }
    function downloadDoc() { const blob = new Blob(['<html><body>'+document.getElementById('answer-area').value.replace(/\n/g,'<br>')+'</body></html>'], {type:'application/msword'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); }
    
    // --- WORKSHEET (STRICT FILTER) ---
    function downloadWorksheetDoc() {
        const mode = document.getElementById('ws-print-mode').value;
        let evidenceList = [];
        let meaningList = [];
        
        // STRICT FILTERING: Only include items marked 'includeInWS'
        const printItems = appData.items.filter(i => i.includeInWS);

        if(printItems.length === 0) { alert("No items selected for worksheet. Check 'WS' in settings."); return; }

        printItems.forEach(i => {
            evidenceList.push(i.type==='structure' ? 'üèóÔ∏è '+i.label : '"'+i.original+'"');
            meaningList.push(i.type==='structure' ? i.detail : i.translation);
        });
        meaningList.sort(() => Math.random() - 0.5);

        let html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
        <head><meta charset='utf-8'><title>Worksheet</title>
        <style>body{font-family:'Calibri',sans-serif;} table{width:100%;border-collapse:collapse;margin-bottom:20px;} td,th{border:1px solid #999;padding:8px;text-align:left;} th{background-color:#eee;} .box-row{height:30px;}</style></head><body>
        <h1>Worksheet: ${appData.textTitle}</h1>
        <p><strong>Question:</strong> ${appData.question}</p>
        <hr><h2>Task 1: Evidence Match-Up</h2>
        <table><tr><th>Evidence</th><th>Meaning (Jumbled)</th></tr>
        ${evidenceList.map((ev, i) => `<tr><td>${ev}</td><td>${meaningList[i]}</td></tr>`).join('')}
        </table><br><h2>Task 2: Analysis</h2>`;

        printItems.forEach((i, idx) => {
            let levelHtml = "";
            const showL1 = (mode === 'all' && appData.worksheetOptions?.lvl1) || mode === '1';
            const showL2 = (mode === 'all' && appData.worksheetOptions?.lvl2) || mode === '2';
            const showL3 = (mode === 'all' && appData.worksheetOptions?.lvl3) || mode === '3';

            if(showL1 && i.level1) levelHtml += `<p>Level 1: ${i.level1.tone?.prompt || 'Tone?'}</p><table style="width:100%;border:1px solid #000;"><tr><td class="box-row">&nbsp;</td></tr><tr><td class="box-row">&nbsp;</td></tr></table>`;
            if(showL2 && i.level2) levelHtml += `<p>Level 2: ${i.level2.tone?.prompt || 'Implication?'}</p><table style="width:100%;border:1px solid #000;"><tr><td class="box-row">&nbsp;</td></tr><tr><td class="box-row">&nbsp;</td></tr></table>`;
            if(showL3 && i.level3) levelHtml += `<p>Level 3: ${i.level3.tone?.prompt || 'Effect?'}</p><table style="width:100%;border:1px solid #000;"><tr><td class="box-row">&nbsp;</td></tr><tr><td class="box-row">&nbsp;</td></tr></table>`;
            
            if(levelHtml) {
                html += `<div style="border:1px solid #333;padding:10px;margin-bottom:15px;"><p><strong>${idx+1}. ${i.type==='structure'?i.label:'"'+i.original+'"'}</strong></p>${levelHtml}</div>`;
                if(i.pageBreak) html += `<br style="page-break-after:always;">`;
            }
        });
        html += "</body></html>";
        const blob = new Blob([html], {type:'application/msword'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'Worksheet.doc'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function saveLocal() { localStorage.setItem('tsa_v55_ctrl', JSON.stringify(appData)); }
    function updateGlobal(k, v) { appData[k]=v; saveLocal(); updateUI(); }
    function openAdmin() { document.getElementById('admin-modal').style.display='flex'; renderTemplateList('tone','list-tmpl-tone'); renderTemplateList('structure','list-tmpl-structure'); renderTemplateList('language','list-tmpl-language'); renderList('markers','list-markers'); renderList('starters','list-starters'); renderList('points','list-points'); renderList('methods','list-methods'); renderList('links','list-links'); renderItems(); initAdminConfig(); 
        if(appData.worksheetOptions) {
            document.getElementById('ws-lvl1').checked = appData.worksheetOptions.lvl1;
            document.getElementById('ws-lvl2').checked = appData.worksheetOptions.lvl2;
            document.getElementById('ws-lvl3').checked = appData.worksheetOptions.lvl3;
        }
    }
    function closeAdmin() { document.getElementById('admin-modal').style.display='none'; }
    function renderTemplateList(type, divId) {
        const div = document.getElementById(divId); div.innerHTML = '';
        if(!appData.analysisTemplates[type]) appData.analysisTemplates[type] = [];
        appData.analysisTemplates[type].forEach((t, i) => { const row = document.createElement('div'); row.className = 'list-item'; row.innerHTML = `<input class="list-input" value="${t}" onchange="updateTemplateItem('${type}',${i},this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('${type}',${i})">X</button>`; div.appendChild(row); });
    }
    function addTemplate(type) { if(!appData.analysisTemplates[type]) appData.analysisTemplates[type] = []; appData.analysisTemplates[type].push("New {word} template"); renderTemplateList(type, 'list-tmpl-'+type); saveLocal(); }
    function updateTemplateItem(type, i, val) { appData.analysisTemplates[type][i] = val; saveLocal(); }
    function deleteTemplateItem(type, i) { appData.analysisTemplates[type].splice(i,1); renderTemplateList(type, 'list-tmpl-'+type); saveLocal(); }
    function renderList(key, divId) { const div = document.getElementById(divId); div.innerHTML = ''; if(!appData[key]) appData[key] = []; appData[key].forEach((item, i) => { const row = document.createElement('div'); row.className = 'list-item'; row.innerHTML = `<input class="list-input" value="${item.replace(/"/g,'&quot;')}" onchange="updateListItem('${key}',${i},this.value)"><button class="btn btn-danger" onclick="deleteListItem('${key}',${i})">X</button>`; div.appendChild(row); }); }
    function updateListItem(key, i, val) { appData[key][i] = val; saveLocal(); updateUI(); }
    function deleteListItem(key, i) { appData[key].splice(i,1); renderList(key, 'list-'+key); saveLocal(); updateUI(); }
    function addItem(key) { appData[key].push("New Item"); renderList(key, 'list-'+key); saveLocal(); }
    function uploadJSON(input) {
        const fr = new FileReader();
        fr.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(!json.analysisTemplates) json.analysisTemplates = defaultData.analysisTemplates;
                ['tone', 'structure', 'language'].forEach(k => { if (json.analysisTemplates[k] && typeof json.analysisTemplates[k] === 'string') { json.analysisTemplates[k] = [json.analysisTemplates[k]]; } });
                appData = json; saveLocal(); openAdmin(); updateUI(); alert("File loaded!");
            } catch(err) { alert("Error: " + err.message); }
        };
        fr.readAsText(input.files[0]); input.value=''; 
    }
    function initAdminConfig() { const opts = ['marker', 'starter', 'point', 'method', 'quote', 'analysis', 'link', 'none']; for(let i=0; i<6; i++) { const sel = document.getElementById(`cfg-slot${i+1}`); if(!sel) continue; sel.innerHTML = ''; opts.forEach(o => sel.add(new Option(o, o))); sel.value = appData.sentenceOrder[i] || 'none'; } }
    function saveStructureConfig() { const newOrder = []; for(let i=0; i<6; i++) { newOrder.push(document.getElementById(`cfg-slot${i+1}`).value); } appData.sentenceOrder = newOrder; saveLocal(); updateUI(); }
    function resetSentenceOrder() { if(confirm("Revert sentence order to default?")) { appData.sentenceOrder = ['starter', 'quote', 'method', 'point', 'analysis', 'link']; saveLocal(); updateUI(); openAdmin(); } }
    function saveWSOptions() {
        appData.worksheetOptions = {
            lvl1: document.getElementById('ws-lvl1').checked,
            lvl2: document.getElementById('ws-lvl2').checked,
            lvl3: document.getElementById('ws-lvl3').checked
        };
        saveLocal();
    }
    function downloadJSON() {
        const blob = new Blob([JSON.stringify(appData)], {type: "text/json;charset=utf-8"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'architect_data.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); alert("Saved!");
    }
    function downloadStudentApp() {
        const clone = JSON.parse(JSON.stringify(appData));
        const htmlContent = document.documentElement.outerHTML;
        const scriptStart = htmlContent.indexOf('const defaultData =');
        const scriptEnd = htmlContent.indexOf('let appData =');
        if(scriptStart === -1 || scriptEnd === -1) { alert("Error."); return; }
        const newScript = `const defaultData = ${JSON.stringify(clone)};\n    `;
        const finalHTML = htmlContent.substring(0, scriptStart) + newScript + htmlContent.substring(scriptEnd);
        const blob = new Blob([finalHTML], {type:'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Student_Lesson.html'; a.click();
    }
    
    // --- SMART EDITOR WITH LENS TOGGLE ---
    function renderItems() {
        const con = document.getElementById('items-container'); con.innerHTML = '';
        if(!appData.items) return;
        appData.items.forEach((item, i) => {
            const div = document.createElement('div'); div.className = 'editor-section';
            const defaultLens = item.type === 'structure' ? 'structure' : 'tone';
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;"><strong>#${i+1} (${item.type})</strong> <div>
                <label><input type="checkbox" class="ws-checkbox" ${item.includeInWS?'checked':''} onchange="updateItemBool(${i}, 'includeInWS', this.checked)">üñ®Ô∏è WS</label>
                <label style="margin-left:10px;"><input type="checkbox" class="ws-checkbox" ${item.pageBreak?'checked':''} onchange="updateItemBool(${i}, 'pageBreak', this.checked)">‚úÇÔ∏è PB</label>
                <button class="btn btn-edit-analysis" onclick="toggleDetails(${i})"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="delItem(${i})"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="${item.custom_q||''}" placeholder="Question" onchange="updateItem(${i},'custom_q',this.value)">
                <input class="admin-input" value="${item.original}" placeholder="Quote" onchange="updateItem(${i},'original',this.value)">
                <div id="details-${i}" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(${i}, this.value)">
                        <option value="tone" ${defaultLens==='tone'?'selected':''}>Tone</option>
                        <option value="structure" ${defaultLens==='structure'?'selected':''}>Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-${i}" class="lens-group ${defaultLens==='tone'?'active':''}"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="${item.level1?.tone?.correct||''}" onchange="updateDeep(${i},'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="${item.level1?.tone?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="${item.level2?.tone?.correct||''}" onchange="updateDeep(${i},'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="${item.level2?.tone?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="${item.level3?.tone?.correct||''}" onchange="updateDeep(${i},'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="${item.level3?.tone?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-${i}" class="lens-group ${defaultLens==='structure'?'active':''}"><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="${item.level1?.structure?.correct||''}" onchange="updateDeep(${i},'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="${item.level1?.structure?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="${item.level2?.structure?.correct||''}" onchange="updateDeep(${i},'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="${item.level2?.structure?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="${item.level3?.structure?.correct||''}" onchange="updateDeep(${i},'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="${item.level3?.structure?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level3','structure',this.value)"></div></div>
                    <div id="lens-language-${i}" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="${item.level1?.language?.correct||''}" onchange="updateDeep(${i},'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="${item.level1?.language?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="${item.level2?.language?.correct||''}" onchange="updateDeep(${i},'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="${item.level2?.language?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="${item.level3?.language?.correct||''}" onchange="updateDeep(${i},'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="${item.level3?.language?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level3','language',this.value)"></div></div>
                </div>
            `;
            con.appendChild(div);
        });
    }
    
    function updateLensVisibility(i, lens) {
        document.getElementById(`lens-tone-${i}`).classList.remove('active');
        document.getElementById(`lens-structure-${i}`).classList.remove('active');
        document.getElementById(`lens-language-${i}`).classList.remove('active');
        document.getElementById(`lens-${lens}-${i}`).classList.add('active');
    }

    function toggleDetails(i) { const el = document.getElementById('details-'+i); el.style.display = el.style.display==='block'?'none':'block'; }
    function updateItem(i, k, v) { appData.items[i][k] = v; saveLocal(); }
    function updateItemBool(i, k, v) { appData.items[i][k] = v; saveLocal(); }
    function updateDeep(i, lvl, type, key, val) { if(!appData.items[i][lvl]) appData.items[i][lvl]={}; if(!appData.items[i][lvl][type]) appData.items[i][lvl][type]={}; appData.items[i][lvl][type][key]=val; saveLocal(); }
    function updateDeepOpts(i, lvl, type, val) { if(!appData.items[i][lvl]) appData.items[i][lvl]={}; if(!appData.items[i][lvl][type]) appData.items[i][lvl][type]={}; appData.items[i][lvl][type].options=val.split(',').map(s=>s.trim()); saveLocal(); }
    function delItem(i) { appData.items.splice(i,1); renderItems(); loadStageSelect(); }
    function addNewItem() { appData.items.push({type:"quote", original:"New", translation:"", includeInWS: true, pageBreak: false, level1:{tone:{correct:"", options:[]}} }); renderItems(); }

    function openWizard() { document.getElementById('wizard-overlay').style.display='flex'; }
    function closeWizard() { document.getElementById('wizard-overlay').style.display='none'; }
    function genPrompt() { /* Same as v45 */ }
    function loadWizardData() { /* Same as v45 */ }
    
    init();
</script>


</body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>